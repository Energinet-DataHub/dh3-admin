<!--
@license
Copyright 2020 Energinet DataHub A/S

Licensed under the Apache License, Version 2.0 (the "License2");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<ng-container *transloco="let t; read: 'marketParticipant.actor.create'">
  <watt-modal size="large" [title]="t('createHeader')">
    <watt-stepper
      class="dh-actors-create-actor-modal__form watt-modal-content--full-width"
      [linear]="true"
      (completed)="createMarketParticipent()"
    >
      <watt-stepper-step
        [enabled]="showCreateNewOrganization() === false"
        [nextButtonLabel]="t('steps.actor')"
        [stepControl]="chooseOrganizationForm"
        [label]="t('organization')"
      >
        <dh-choose-organization-step
          [chooseOrganizationForm]="chooseOrganizationForm"
          (choosenOrganizationDomain)="setChoosenOrganizationDomain($event)"
          (toggleShowCreateNewOrganization)="toggleShowCreateNewOrganization()"
        />
      </watt-stepper-step>
      <watt-stepper-step
        [enabled]="showCreateNewOrganization()"
        [nextButtonLabel]="t('steps.actor')"
        [stepControl]="newOrganizationForm"
        [label]="t('organization')"
      >
        <div class="dh-actors-create-actor-organization">
          <vater-stack direction="row" justify="space-between" fill="horizontal">
            <h4>{{ t("newOrganization") }}</h4>
            <watt-button variant="text" (click)="toggleShowCreateNewOrganization()">{{
              t("searchDatahub")
            }}</watt-button>
          </vater-stack>

          <vater-stack gap="m" align="flex-start" direction="row">
            <watt-dropdown
              [label]="t('country')"
              translate="marketParticipant.actor.create.counties"
              [options]="countryOptions"
              [formControl]="newOrganizationForm.controls.country"
              dhDropdownTranslator
            />
            <watt-text-field
              [formControl]="newOrganizationForm.controls.cvrNumber"
              [label]="t('cvrNumber')"
            >
              <watt-field-error
                *ngIf="newOrganizationForm.controls.cvrNumber.hasError('invalidCvrNumber')"
              >
                {{ t("cvrInvalid") }}
              </watt-field-error>
            </watt-text-field>
          </vater-stack>
          <vater-stack gap="m" align="flex-start">
            <watt-text-field
              [formControl]="newOrganizationForm.controls.companyName"
              [label]="t('companyName')"
            />
            <watt-text-field
              [prefix]="'alternateEmail'"
              [formControl]="newOrganizationForm.controls.domain"
              [label]="t('domain')"
            >
              <watt-field-error *ngIf="newOrganizationForm.controls.domain.hasError('pattern')">
                {{ t("domainInvalid") }}
              </watt-field-error>
            </watt-text-field>
          </vater-stack>
        </div>
      </watt-stepper-step>
      <watt-stepper-step
        [stepControl]="newActorForm"
        [previousButtonLabel]="t('steps.organization')"
        [nextButtonLabel]="t('steps.invite')"
        [label]="t('marketParty')"
      >
        <vater-stack gap="xl" class="dh-actors-create-actor" align="flex-start" direction="row">
          <vater-stack fill="horizontal" align="flex-start" direction="column">
            <h4>{{ t("marketParty") }}</h4>
            <watt-text-field
              [formControl]="newActorForm.controls.glnOrEicNumber"
              [label]="t('glnOrEicNumber')"
            >
              <watt-field-error *ngIf="newActorForm.controls.glnOrEicNumber.hasError('pattern')">
                {{ t("glnOrEicInvalid") }}
              </watt-field-error>
            </watt-text-field>
            <watt-text-field
              [formControl]="newActorForm.controls.name"
              [label]="t('name')"
              [tooltip]="t('tooltip')"
            />
            <watt-dropdown
              translate="marketParticipant.marketRoles"
              dhDropdownTranslator
              [options]="marketRoleOptions"
              (ngModelChange)="onMarketRoleChange($event)"
              [formControl]="newActorForm.controls.marketrole"
              [label]="t('marketRole')"
            />
            <watt-dropdown
              *ngIf="showGridAreaOptions()"
              [options]="gridAreaOptions"
              [formControl]="newActorForm.controls.gridArea"
              [label]="t('gridArea')"
            />
          </vater-stack>
          <vater-stack fill="horizontal" align="flex-start" direction="column">
            <h4>{{ t("contact") }}</h4>
            <watt-text-field
              [formControl]="newActorForm.controls.contact.controls.departmentOrName"
              [label]="t('departmentOrName')"
            />
            <watt-text-field
              [formControl]="newActorForm.controls.contact.controls.email"
              [label]="t('email')"
            >
              <watt-field-error
                *ngIf="newActorForm.controls.contact.controls.email.hasError('pattern')"
              >
                {{ t("wrongEmailPattern") }}
              </watt-field-error>
            </watt-text-field>
            <watt-text-field
              [formControl]="newActorForm.controls.contact.controls.phone"
              [label]="t('phone')"
            >
              <watt-field-error
                *ngIf="newActorForm.controls.contact.controls.phone.hasError('pattern')"
              >
                {{ t("phoneInvalid") }}
              </watt-field-error>
            </watt-text-field>
          </vater-stack>
        </vater-stack>
      </watt-stepper-step>
      <watt-stepper-step
        [label]="t('useradmin')"
        [stepControl]="newUserForm"
        [previousButtonLabel]="t('steps.actor')"
        [nextButtonLabel]="t('steps.create')"
      >
        <div class="dh-actors-create-actor-invite-user">
          <vater-stack gap="m" align="flex-start" direction="row">
            <watt-text-field
              [formControl]="newUserForm.controls.firstName"
              [label]="t('firstname')"
            />
            <watt-text-field
              [formControl]="newUserForm.controls.lastName"
              [label]="t('lastname')"
            />
          </vater-stack>
          <vater-stack gap="m" align="flex-start">
            <watt-text-field [formControl]="newUserForm.controls.email" [label]="t('email')">
              <span class="domain">&#64;{{ getChoosenOrganizationDomain() }}</span>
              <watt-field-error
                *ngIf="newActorForm.controls.contact.controls.email.hasError('pattern')"
              >
                {{ t("wrongEmailPattern") }}
              </watt-field-error>
            </watt-text-field>
            <watt-text-field [formControl]="newUserForm.controls.phone" [label]="t('phone')">
              <watt-field-error *ngIf="newUserForm.controls.phone.hasError('pattern')">
                {{ t("phoneInvalid") }}
              </watt-field-error>
            </watt-text-field>
          </vater-stack>
          <watt-card variant="solid">
            <watt-card-title>
              <ng-container
                *ngTemplateOutlet="
                  userRolesHeadline;
                  context: {
                    $implicit: dataSource.data.length
                  }
                "
              />
            </watt-card-title>

            <vater-flex fill="vertical" scrollable>
              <watt-table
                [dataSource]="dataSource"
                [columns]="columns"
                sortBy="name"
                sortDirection="asc"
                [selectable]="true"
                (selectionChange)="selectedUserRoles($event)"
                [sortClear]="false"
              >
                <ng-container
                  *wattTableCell="columns['name']; header: t('columns.name'); let userRole"
                >
                  {{ userRole.name }}
                </ng-container>

                <ng-container
                  *wattTableCell="
                    columns['description'];
                    header: t('columns.description');
                    let userRole
                  "
                >
                  {{ userRole.description }}
                </ng-container>
              </watt-table>
            </vater-flex>
          </watt-card>

          <ng-template #userRolesHeadline let-userRolesCount>
            <ng-container
              *transloco="let t; read: 'admin.userManagement.tabs.roles.userRolesHeadline'"
            >
              <h4 *ngIf="userRolesCount === 1">
                {{ t("singular", { userRolesCount }) }}
              </h4>

              <h4 *ngIf="userRolesCount !== 1">
                {{ t("plural", { userRolesCount }) }}
              </h4>
            </ng-container>
          </ng-template>
        </div>
      </watt-stepper-step>
    </watt-stepper>
  </watt-modal>
</ng-container>
